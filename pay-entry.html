<script src="https://js.stripe.com/v3/"></script>
<script>
const form = document.getElementById("paidForm");
const successMsg = document.getElementById("successMsg");
const closedBox = document.getElementById("closedBox");
const payBtn = document.getElementById("payBtn");
const currentParticipants = document.getElementById("currentParticipants");

// ðŸ”‘ Stripe public key (sandbox)
const stripe = Stripe('pk_test_51SpsG3Rcb8bsNOMZ8uNemlKu3MfIS4RnkpccxNH97acZamvdNnYDAFATNTRTVOYx2R8kAG0VAOqnQ8ViDJVXz1GQ002V0SHibZ');

// âœ… URL-ul TÄ‚U FINAL Google Apps Script
const scriptURL = "https://script.google.com/macros/s/AKfycbybgXJmfL4Fwj7gCMypxZQwA9ZLe8lq8qxlpuJcxE7tevSF0cRWr7KO4L4SAMSfFhYP/exec";

// PreÈ› intrare (EUR)
const entryAmount = 2.3;

/* ðŸ” Verificare status la Ã®ncÄƒrcare */
window.addEventListener("DOMContentLoaded", () => {
  fetch(scriptURL)
    .then(res => res.json())
    .then(data => {
      if (data.currentParticipants !== undefined) {
        currentParticipants.textContent = `Current participants: ${data.currentParticipants}`;
      }

      if (data.status === "closed") {
        form.style.display = "none";
        successMsg.style.display = "none";
        closedBox.style.display = "block";
      }
    })
    .catch(err => console.error("Status check error", err));
});

/* ðŸ’³ Submit + Stripe */
form.addEventListener("submit", e => {
  e.preventDefault();

  payBtn.disabled = true;
  payBtn.textContent = "Processing...";

  const payload = {
    name: form.name.value.trim(),
    phone: form.phone.value.trim(),
    amount: entryAmount
  };

  fetch(scriptURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {

    if (data.status === "closed") {
      form.style.display = "none";
      closedBox.style.display = "block";
      return;
    }

    if (!data.sessionId) {
      throw new Error("No Stripe session returned");
    }

    // ðŸ‘‰ Redirect Stripe Checkout
    return stripe.redirectToCheckout({ sessionId: data.sessionId });
  })
  .catch(err => {
    console.error(err);
    successMsg.textContent = "Error initializing payment. Please try again later.";
    payBtn.disabled = false;
    payBtn.textContent = "Pay Now";
  });
});
</script>
